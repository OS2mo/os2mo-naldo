<script lang="ts">
  import { _ } from "svelte-i18n"
  import { capital } from "$lib/utils/helpers"
  import { env } from "$lib/env"
  import DetailTable from "$lib/components/shared/DetailTable.svelte"
  import { tenses } from "$lib/stores/tenses"
  import type { ComponentType, SvelteComponent } from "svelte"
  import AssociationTable from "$lib/components/tables/AssociationTable.svelte"
  import AddressTable from "$lib/components/tables/AddressTable.svelte"
  import EngagementTable from "$lib/components/tables/EngagementTable.svelte"
  import ItUserTable from "$lib/components/tables/ITUserTable.svelte"
  import OrgUnitTable from "$lib/components/tables/EngagementTable.svelte"
  import RelatedUnitsTable from "$lib/components/tables/RelatedUnitsTable.svelte"

  export let headers: Header[]
  export let table: ComponentType<SvelteComponent>

  // Specific for admin interface
  export let facetUuid: string | undefined = undefined

  $: {
    if (!env.PUBLIC_SHOW_TIME_PLANNING && table === OrgUnitTable) {
      headers = headers.filter(
        (header) => header.title !== capital($_("time_planning"))
      )
    }

    if (!env.PUBLIC_SHOW_ORG_UNIT_LEVEL && table === OrgUnitTable) {
      headers = headers.filter(
        (header) => header.title !== capital($_("org_unit_level"))
      )
    }

    if (!env.PUBLIC_SHOW_PRIMARY_ENGAGEMENT && table == EngagementTable) {
      headers = headers.filter((header) => header.title !== capital($_("primary")))
    }

    if (!env.PUBLIC_SHOW_PRIMARY_ASSOCIATION && table == AssociationTable) {
      headers = headers.filter((header) => header.title !== capital($_("primary")))
    }

    if (!env.PUBLIC_SHOW_EXTENSION_2 && table === EngagementTable) {
      headers = headers.filter(
        (header) => header.title !== capital($_("department_code"))
      )
    }

    if (!env.PUBLIC_SHOW_EXTENSION_1 && table === EngagementTable) {
      headers.splice(3, 1)
    }

    if (!env.PUBLIC_AUDITLOG && table !== RelatedUnitsTable) {
      // If we don't want to show Auditlog-button, remove one of the empty headers. Otherwise the table looks weird
      headers.pop()
    }

    if (!env.PUBLIC_SHOW_ITUSER_CONNECTIONS) {
      if (table === EngagementTable) {
        headers = headers.filter(
          (header) => header.title !== capital($_("ituser", { values: { n: 2 } }))
        )
      }
      if (table === AddressTable) {
        headers = headers.filter(
          (header) => header.title !== capital($_("ituser", { values: { n: 1 } }))
        )
      }
      if (table === ItUserTable) {
        headers = headers.filter(
          (header) => header.title !== capital($_("engagement", { values: { n: 1 } }))
        )
      }
    }
  }
</script>

<DetailTable {headers}>
  {#if $tenses.future}
    <tr>
      <th class="px-4 py-3 text-left font-bold text-secondary bg-slate-200" colSpan={15}
        >{capital($_("future"))}</th
      >
    </tr>
    <svelte:component this={table} tense="future" {facetUuid} />
  {/if}
  {#if $tenses.present}
    <tr>
      <th class="px-4 py-3 text-left font-bold text-secondary bg-slate-200" colSpan={15}
        >{capital($_("present"))}</th
      ></tr
    >
    <svelte:component this={table} tense="present" {facetUuid} />
  {/if}
  {#if $tenses.past}
    <tr>
      <th class="px-4 py-3 text-left font-bold text-secondary bg-slate-200" colSpan={15}
        >{capital($_("past"))}</th
      >
    </tr>
    <svelte:component this={table} tense="past" {facetUuid} />
  {/if}
</DetailTable>
